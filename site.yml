---
- hosts: all

  tasks:
  - include_role:
      name: apt-role
    vars: 
      aptPackagesToInstall: "{{ aptPackages }}"

  - include_role:
      name: usermanagement-role
    vars:
      user: "{{ item }}"
    loop: "{{ userslist }}"

  - include_role:
      name: sshserver

  - include_role:
      name: development-userrole
    vars:
      user: "{{ outer_item }}"
    loop: "{{ userslist }}"
    loop_control:
      loop_var: outer_item

  - name: Create pyhuect target directory
    become: true
    become_user: robert
    file: 
      path: /home/robert/test
      state: directory

  - name: Git checkout pyhuect
    become: true
    become_user: robert
    ansible.builtin.git:
      repo: git@github.com:robertreems/pyhuect.git
      dest: /home/robert/pyhuect/
    register: pyhuectservice

  - name: Set systemctl service file
    become: true
    copy:
      dest: /etc/systemd/system/pyhuect.service
      content: |
        [Unit]
        Description=Roberts pyhue ct service
        Requires=network.target

        [Service]
        Type=simple
        User=robert
        ExecStart=/usr/bin/python3 /home/robert/pyhuect/main.py

        Restart=always
        RestartSec=60

        [Install]
        WantedBy=multi-user.target
    register: pyhuectservice

  - name: Reload the systemd daemon
    become: true
    ansible.builtin.systemd:
      daemon_reload: yes
    when: pyhuectservice.changed

  - name: (re)start the pyhuect.service
    become: true
    ansible.builtin.systemd:
      name: pyhuect.service
      state: restarted
    when: pyhuectservice.changed
